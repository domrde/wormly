<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wormly</title>
    <script src="http://underscorejs.org/underscore-min.js"></script>
</head>
<body>

<script type="text/javascript">
    const backgroundColor = "lightblue";

    function clearCanvas(canvas) {
        const context = canvas.getContext("2d");
        context.fillStyle = backgroundColor;
        context.fillRect(0, 0, canvas.width, canvas.height)
    }

    function drawObjects(canvas, objectsList) {
        const context = canvas.getContext("2d");
        for (var i = objectsList.length - 1; i >= 0; i--) {
            const object = objectsList[i];
            context.fillStyle = object.color;
            context.strokeStyle = "black";
            context.beginPath();
            context.arc(object.x, object.y, object.d / 2.0, 0, 2.0 * Math.PI);
            context.fill();
            context.stroke();
        }
    }

    function writeCoordinates(canvas, y, x) {
        const context = canvas.getContext("2d");
        context.fillStyle = "black";
        context.font = "12px Arial";
        context.fillText("(" + Math.round(y) + ", " + Math.round(x) + ")", 10, 15);
    }

    window.onload = function () {
        const ws = new WebSocket("ws://" + window.location.host + "/wormly");
        const canvas = document.createElement('canvas');

        ws.onopen = function () {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            canvas.backgroundColor = "lightblue";

            const body = document.getElementsByTagName("body")[0];
            body.appendChild(canvas);

            ws.send(JSON.stringify({
                height: canvas.height,
                width: canvas.width,
                $type: "wormly.ConnectionHandler.CanvasSize"
            }));

            ws.send(JSON.stringify({
                name: "unused",
                $type: "wormly.ConnectionHandler.StartGameIn"
            }));

            window.addEventListener('resize', _.throttle(function () {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                ws.send(JSON.stringify({
                    height: canvas.height,
                    width: canvas.width,
                    $type: "wormly.ConnectionHandler.CanvasSize"
                }));
            }, 50));
        };

        canvas.onmousemove = _.throttle(function (ev) {
            const centerY = canvas.height / 2.0;
            const centerX = canvas.width / 2.0;
            /*
                      | 90
                      |
                 0    |     180
                 ----------->
                 0    |     -180
                      |
                      V -90
             */
            var angle = Math.atan2(centerY - ev.clientY, centerX - ev.clientX);
            ws.send(JSON.stringify({
                angle: angle,
                $type: "wormly.ConnectionHandler.CursorPositionIn"
            }));
        }, 50);

        ws.onmessage = function (ev) {
            const parsedData = JSON.parse(ev.data);
            switch (parsedData.$type) {
                case "wormly.ConnectionHandler.VisibleObjectsOut":
                    console.log(parsedData);
                    clearCanvas(canvas);
                    drawObjects(canvas, parsedData.food);
                    drawObjects(canvas, parsedData.snakeParts);
                    writeCoordinates(canvas, parsedData.y, parsedData.x);
                    break;

                case "wormly.ConnectionHandler.CollisionOut":
                    window.alert("Collision");
                    break;

                default:
                    console.log(parsedData);
            }
        };
    };
</script>

</body>
</html>