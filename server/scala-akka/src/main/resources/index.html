<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wormly</title>
    <script src="http://underscorejs.org/underscore-min.js"></script>
</head>
<body>

<script type="text/javascript">
    const backgroundColor = "lightblue";

    function clearCanvas(canvas) {
        const context = canvas.getContext("2d");
        context.fillStyle = backgroundColor;
        context.fillRect(0, 0, canvas.width, canvas.height)
    }

    function drawObjects(canvas, snakePartsList, offsetY, offsetX) {
        const context = canvas.getContext("2d");
        _.each(snakePartsList, function(part) {
            const diam = canvas.height / 20.0;
            const y = (diam / part.d) * (part.y - offsetY);
            const x = (diam / part.d) * (part.x - offsetX);
            context.fillStyle = part.color;
            context.beginPath();
            context.arc(x + canvas.width / 2.0, y + canvas.height / 2.0, diam / 2.0, 0, 2.0 * Math.PI);
            context.fill();
        });
    }

    window.onload = function() {
        const ws = new WebSocket("ws://" + window.location.host + "/wormly");
        const canvas = document.createElement('canvas');

        ws.onopen = function () {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            canvas.backgroundColor = "lightblue";

            const body = document.getElementsByTagName("body")[0];
            body.appendChild(canvas);

            ws.send(JSON.stringify({
                name: "unused",
                $type: "wormly.ConnectionHandler.StartGameIn"
            }));
        };

        canvas.onmousemove = _.throttle(function (ev) {
            const centerY = canvas.height / 2.0;
            const centerX = canvas.width / 2.0;
            /*
                      | 90
                      |
                 0    |     180
                 ----------->
                 0    |     -180
                      |
                      V -90
             */
            var angle = Math.atan2(centerY - ev.clientY, centerX - ev.clientX);
            ws.send(JSON.stringify({
                angle: angle,
                $type: "wormly.ConnectionHandler.CursorPositionIn"
            }));
        }, 50);

        ws.onmessage = function (ev) {
            const parsedData = JSON.parse(ev.data);
            switch (parsedData.$type) {
                case "wormly.ConnectionHandler.VisibleObjectsOut":
                    clearCanvas(canvas);
                    drawObjects(canvas, parsedData.food, parsedData.offsetY, parsedData.offsetX);
                    drawObjects(canvas, parsedData.snakeParts, parsedData.offsetY, parsedData.offsetX);
                    break;

                case "wormly.ConnectionHandler.CollisionOut":
                    window.alert("Collision");
                    break;

                default:
                    console.log(parsedData);
            }
        };
    };
</script>

</body>
</html>